#!/usr/bin/env node\n\n/**\n * í–¥ìƒëœ SUMIFS ê³„ì‚° ì—”ì§„ í…ŒìŠ¤íŠ¸\n * ì…€ ì£¼ì†Œ ê¸°ë°˜ ì§ì ‘ ì ‘ê·¼ìœ¼ë¡œ 100% ì •í™•ë„ ë‹¬ì„± ëª©í‘œ\n */\n\nconst EnhancedCalculationEngine = require('./src/engines/EnhancedCalculationEngine');\nconst XLSX = require('xlsx');\nconst path = require('path');\n\nasync function extractSUMIFSFormulas(filePath) {\n  try {\n    console.log(`Excel íŒŒì¼ì—ì„œ SUMIFS ìˆ˜ì‹ ì¶”ì¶œ ì¤‘...`);\n    \n    const workbook = XLSX.readFile(filePath, { cellFormula: true });\n    const formulas = [];\n\n    workbook.SheetNames.forEach(sheetName => {\n      const worksheet = workbook.Sheets[sheetName];\n      \n      Object.keys(worksheet).forEach(cellAddress => {\n        if (cellAddress.startsWith('!')) return;\n        \n        const cell = worksheet[cellAddress];\n        if (cell.f && cell.f.includes('SUMIFS')) {\n          formulas.push({\n            sheet: sheetName,\n            cell: cellAddress,\n            formula: cell.f,\n            value: cell.v\n          });\n        }\n      });\n    });\n\n    console.log(`âœ… SUMIFS ìˆ˜ì‹ ì¶”ì¶œ ì™„ë£Œ: ${formulas.length}ê°œ`);\n    return formulas;\n    \n  } catch (error) {\n    console.error('Excel íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);\n    throw error;\n  }\n}\n\nasync function testEnhancedSUMIFS() {\n  console.log('=== í–¥ìƒëœ SUMIFS ê³„ì‚° ì—”ì§„ í…ŒìŠ¤íŠ¸ ===\\n');\n\n  const excelPath = path.join(__dirname, '..', 'decrypted_sample.xlsx');\n  console.log(`Excel íŒŒì¼ ê²½ë¡œ: ${excelPath}`);\n\n  try {\n    // 1. ì—”ì§„ ì´ˆê¸°í™” ë° Excel íŒŒì¼ ë¡œë“œ\n    const engine = new EnhancedCalculationEngine();\n    await engine.loadExcelFile(excelPath);\n\n    // 2. SUMIFS ìˆ˜ì‹ ì¶”ì¶œ\n    const formulas = await extractSUMIFSFormulas(excelPath);\n    console.log(`\\nì¶”ì¶œëœ SUMIFS ìˆ˜ì‹: ${formulas.length}ê°œ\\n`);\n\n    // 3. ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ (ì²˜ìŒ 10ê°œ)\n    console.log('=== ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ (ì²˜ìŒ 10ê°œ) ===');\n    const sampleFormulas = formulas.slice(0, 10);\n    \n    for (let i = 0; i < sampleFormulas.length; i++) {\n      const formula = sampleFormulas[i];\n      \n      try {\n        console.log(`\\n${i + 1}. [${formula.sheet}!${formula.cell}]`);\n        console.log(`   ìˆ˜ì‹: ${formula.formula}`);\n        console.log(`   Excel ê²°ê³¼: ${formula.value}`);\n        \n        const jsResult = engine.executeSUMIFS(formula);\n        console.log(`   JavaScript ê²°ê³¼: ${jsResult}`);\n        \n        const match = jsResult === (formula.value || 0);\n        console.log(`   ë§¤ì¹­: ${match ? 'âœ…' : 'âŒ'}`);\n        \n        if (!match) {\n          console.log(`   ì°¨ì´: ${Math.abs(jsResult - (formula.value || 0))}`);\n        }\n        \n      } catch (error) {\n        console.log(`   âŒ ì˜¤ë¥˜: ${error.message}`);\n      }\n    }\n\n    // 4. ì „ì²´ í…ŒìŠ¤íŠ¸ (ì²˜ìŒ 50ê°œë¡œ ì œí•œ)\n    console.log('\\n\\n=== ì „ì²´ í…ŒìŠ¤íŠ¸ (ì²˜ìŒ 50ê°œ) ===');\n    const testFormulas = formulas.slice(0, 50);\n    const results = await engine.executeAllSUMIFS(testFormulas);\n\n    // 5. ê²°ê³¼ ë¶„ì„\n    console.log('\\n=== ê²°ê³¼ ë¶„ì„ ===');\n    if (results.accuracy >= 95) {\n      console.log('ğŸ‰ í…ŒìŠ¤íŠ¸ ì„±ê³µ: 95% ì´ìƒ ì •í™•ë„ ë‹¬ì„±!');\n    } else if (results.accuracy >= 90) {\n      console.log('âœ… í…ŒìŠ¤íŠ¸ ì–‘í˜¸: 90% ì´ìƒ ì •í™•ë„ ë‹¬ì„±');\n    } else {\n      console.log('âš ï¸  í…ŒìŠ¤íŠ¸ ê°œì„  í•„ìš”: ì •í™•ë„ê°€ 90% ë¯¸ë§Œ');\n    }\n\n    // ë¶ˆì¼ì¹˜ ì¼€ì´ìŠ¤ ë¶„ì„\n    const mismatches = results.comparisons.filter(c => !c.match);\n    if (mismatches.length > 0) {\n      console.log(`\\në¶ˆì¼ì¹˜ ì¼€ì´ìŠ¤ (ì²˜ìŒ 5ê°œ):`);\n      mismatches.slice(0, 5).forEach((mismatch, index) => {\n        console.log(`${index + 1}. [${mismatch.sheet}!${mismatch.cell}]`);\n        console.log(`   JavaScript: ${mismatch.jsResult}`);\n        console.log(`   Excel: ${mismatch.excelResult}`);\n        console.log(`   ì°¨ì´: ${Math.abs(mismatch.jsResult - mismatch.excelResult)}`);\n      });\n    }\n\n    // ì˜¤ë¥˜ ì¼€ì´ìŠ¤ ë¶„ì„\n    if (results.errors.length > 0) {\n      console.log(`\\nì˜¤ë¥˜ ì¼€ì´ìŠ¤ (ì²˜ìŒ 5ê°œ):`);\n      results.errors.slice(0, 5).forEach((error, index) => {\n        console.log(`${index + 1}. [${error.sheet}!${error.cell}] ${error.error}`);\n      });\n    }\n\n    return results;\n\n  } catch (error) {\n    console.error('í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);\n    throw error;\n  }\n\n  console.log('\\n=== í–¥ìƒëœ SUMIFS ê³„ì‚° ì—”ì§„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');\n}\n\n// ìŠ¤í¬ë¦½íŠ¸ ì§ì ‘ ì‹¤í–‰ ì‹œ\nif (require.main === module) {\n  testEnhancedSUMIFS().catch(console.error);\n}\n\nmodule.exports = { testEnhancedSUMIFS };